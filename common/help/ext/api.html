<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel="stylesheet" type="text/css" href="../shared/style.css">
</head>
<body marginwidth="0" marginheight="0">
<table width="100%" height="30" border="0" cellspacing="0" cellpadding="5" bgcolor="#E0E0E0">
<tr><td align="left" valign="middle" class="title">API шелла</td></tr></table>
<br>
<div align="justify">
<br>

API в основном используется клиентами программ контроля, хотя может быть полезным и для любых сторонних утилит.<br>
<br>
Все функции реализованы ввиде COM-сервера.<br>
Примеры использования для C, C++, Delphi находятся <a href="examples.rar">здесь</a><br>
<br>
Общие замечания:<br>
- доступ к функциям осуществляется через единый интерфейс IRunpadProShell<br>
- старые интерфейсы IRunpadShell/IRunpadShell2 доступны лишь для обратной совместимости<br>
- попытки использовать API на момент, когда еще не выполнен Logon пользователя, приведут к неудаче (это следует учесть в сервисных приложениях)<br>
- все функции возвращают S_OK в случае успеха и другие коды в противном случае<br>
- функции не являются Unicode<br>
- API доступно только в 32-битном виде<br>
<br>
<br>

<hr>
<b>HRESULT GetShellPid(OUT DWORD *lpdwPID);</b><br><br>
Возвращает PID процесса шелла.<br>
<br>
Клиент может использовать эту информацию, чтобы не снимать и не закрывать процесс шелла. Это рекомендуется, несмотря на встроенную защиту шелла от снятия процесса.<br>
Если шелл не загружен, то будет возвращена ошибка.<br>
<br>
<hr>
<b>HRESULT GetShellMode(OUT DWORD *lpdwFlags);</b><br><br>
Возвращает флаги режимов шелла:<br>
RSM_MONITOR - показывает, включен (1) или отключен (0) монитор<br>
RSM_INPUT - показывает, разрешены (1) или запрещены (0) мышь и клавиатура<br>
RSM_BLOCKED - показывает, заблокирован (1) или разблокирован (0) запуск программ<br>
<br>
<hr>
<b>HRESULT IsShellOwnedWindow(HWND hWnd, OUT BOOL *lpbOwned);</b><br><br>
Проверяет, является ли какое-угодно окно окном шелла.<br>
С такими окнами рекомендуется ничего не делать клиенту (хотя в шелле встроена защита от подобных действий).<br>
<br>
<hr>
<b>HRESULT GetFolderPath(RSHELLFOLDER dwFolderType, OUT LPSTR lpszPath, DWORD cbPathLen);</b><br><br>
Возвращает путь к папке шелла (буфер должен быть длиной не менее MAX_PATH):<br>
RSF_USERFOLDER - папка пользователя <br>
RSF_VIPFOLDER - личная (VIP) папка пользователя. Последний элемент в VIP-папке всегда является именем текущего VIP-пользователя <br>
<br>
При отсутствии ресурса может быть возвращена пустая строка.<br>
<br>
<hr>
<b>HRESULT GetCurrentSheet(OUT LPSTR lpszName, DWORD cbNameLen);</b><br><br>
Возвращает имя рабочей закладки (длина буфера должна быть не менее MAX_PATH)<br>
<br>
<hr>
<b>HRESULT EnableSheets(IN LPCSTR lpszName, BOOL bEnable);</b><br><br>
Запрещает или разрешает закладку, заданную по имени. Если lpszName равно NULL, то действие применяется ко всем закладкам.<br>
Изменения хранятся только в данном сеансе пользователя. При следующем старте шелла все закладки снова будут разрешены.<br>
Функция является асинхронной.<br>
<br>
<hr>
<b>HRESULT RegisterClient(IN LPCSTR lpszClientName, IN LPCSTR lpszClientPath, DWORD dwFlags);</b><br><br>
Выполняет регистрацию программы клиента. <br>
Регистрация нужна для того, чтобы нельзя было запускать ярлыки до старта клиента, работал режим автовосстановления клиента (на случай если его снимут), а также чтобы разрешить иконку клиента в трее и добавить его в список неснимаемых задач шелла.<br>
Все эти действия можно сделать вручную, путем прописывания в настройках шелла файла клиента, а можно автоматически через данное API.<br>
Рекомендуется вызывать данную функцию при старте клиента один раз. Все изменения не сохраняются в последующих сеансах работы шелла.<br>
В качестве параметров передается символическое название клиента (например, "GameClass Client"), а также полный путь к его EXE-файлу. <br>
Параметр dwFlags зарезервирован и должен быть нулевым.<br>
Функция является асинхронной.<br>
<br>
<hr>
<b>HRESULT ShowInfoMessage(IN LPCSTR lpszText, DWORD dwFlags);</b><br><br>
Показывает информационное сообщение на экране или во всплывающей подсказке в трее.<br>
Длина строки не должна превышать 255 символов.<br>
В поле флагов HIWORD задает длительность отображения в секундах (0 - по умолчанию), LOWORD может быть одним из значений:<br>
RSMSG_DESKTOP - сообщение на экране<br>
RSMSG_TRAY - сообщение во всплывающей подсказке в трее<br>
RSMSG_STATUS - изменение статусной строки, длительность игнорируется<br>
Функция является асинхронной.<br>
<br>
<hr>
<b>HRESULT DoSingleAction(RSHELLACTION dwAction);</b><br><br>
Выполняет определенное действие:<br>
RSA_MINIMIZEALLWINDOWS - минимизирует все активные окна<br>
RSA_KILLALLTASKS - снимает все разрешенные задачи (аналог команды шелла/программы оператора)<br>
RSA_RESTOREVMODE - восстанавливает видеорежим (после выхода из проблемных игр)<br>
RSA_CLOSECHILDWINDOWS - закрывает все дочерние окна шелла<br>
RSA_CLOSEACTIVESHEET - закрывает активную закладку<br>
RSA_TURNMONITORON - включает монитор<br>
RSA_TURNMONITOROFF - отключает монитор<br>
RSA_ENDVIPSESSION - завершает личную (VIP) сессию клиента<br>
RSA_RUNPROGRAMDISABLE - запрещает запуск ярлыков. Смотрите также опцию настроек шелла "Блокировка".<br>
RSA_RUNPROGRAMENABLE - разрешает запуск ярлыков. Смотрите также опцию настроек шелла "Блокировка".<br>
RSA_LOGOFF - завершение сеанса<br>
RSA_LOGOFFFORCE - завершение сеанса (форсированное)<br>
RSA_RUNSCREENSAVER - запуск хранителя экрана<br>
RSA_SHOWLA - показывает окно лицензионного соглашения (если установлено в настройках шелла)<br>
Функция является асинхронной.<br>
<br>
<hr>
<b>HRESULT VipLogin(IN LPCSTR lpszLogin, IN LPCSTR lpszPassword, BOOL bWait);</b><br><br>
Выполняет операцию входа в личную (VIP) сессию пользователя по логину и паролю.<br>
Пароль игнорируется если включена соотв. опция в настройках шелла (см. вкладку "VIP-клиенты").<br>
Если в текущий момент сессия уже начата, то сначала произойдет завершение текущей сессии, а затем начало новой.<br>
Функция не будет работать если в шелле не разрешена работа с VIP-сессиями (запрещен соотв. пункт главного меню).<br>
Параметр bWait определяет, ожидать фактического выполнения команды или нет. Если не ожидать, то функция будет асинхронной, а с ожиданием таймаут может быть вплоть до 10-12 секунд.<br>
Следует учесть, что в синхронном варианте при ожидании обрабатываются оконные сообщения Windows.<br>
Код возврата имеет смысл проверять только если bWait=TRUE<br>
<br>
<hr>
<b>HRESULT VipRegister(IN LPCSTR lpszLogin, IN LPCSTR lpszPassword, BOOL bWait);</b><br><br>
Полностью аналогична предыдущей функции с тем лишь отличием, что происходит регистрация нового пользователя в базе.<br>
Ошибка может быть возвращена если регистрация запрещена на сервере или пользователь уже есть в базе.<br>
При успешном выполнении происходит автоматический логин пользователя.<br>
<br>
<hr>
<b>HRESULT VipLogout(BOOL bWait);</b><br><br>
Завершает личную сессию пользователя. <br>
См. также функции VipLogin, VipRegister.<br>
<br>
<hr>
<b>HRESULT TempOffShell(IN LPCSTR lpszPasswordMD5, BOOL bShowReminder);</b><br><br>
Выполняет временное отключение шелла.<br>
На вкладке настроек "Аварийное отключение" должен быть установлен пароль аварийного отключения, MD5-хэш которого нужно передать в эту функцию (при вычислении MD5 пароль нужно привести к нижнему регистру).<br>
Второй параметр позволяет показывать или не показывать предупреждение о завершении сеанса после простоя N-минут, при этом если предупреждения не показывать, то и автоматического завершения сеанса не произойдет.<br>
<br>
<hr>
<b>Переменные окружения</b><br><br>
Доступны следующие переменные окружения (при включенном шелле):<br>
%RS_FOLDER% - Путь к базовой папке, куда установлен клиентский шелл<br>
%RS_MACHINE% - Описание машины (может быть ее номер)<br>
%RS_LOC% - Местоположение машины<br>
%RS_VIPFOLDER% - Путь к личной VIP-папке пользователя<br>
%RS_VIPSESSION% - Название личной VIP-сессии (имя VIP-пользователя)<br>
%RS_USERFOLDER% - Путь к папке пользователя<br>
<br>

<br>
<br>
</div>
</body>
</html>
